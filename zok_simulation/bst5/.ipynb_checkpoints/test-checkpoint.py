import subprocess
import time
import os
import json

# Path to the directory containing ZoKrates programs
# program_directory = "./program"
program_directory = "./programs"
top_directory = "."

# Function to get the size of a file
def get_file_size(file_path):
    return os.path.getsize(file_path)

# Function to measure compilation time
def compile_program(program_path):
    start_time = time.time()
    compile_output = subprocess.run(["zokrates", "compile", "-i", program_path])
    end_time = time.time()
    output_file_path = os.path.join(top_directory, 'out')
    circuit_size = get_file_size(output_file_path)
    return end_time - start_time, circuit_size

# Function to execute the program and measure execution time
def execute_program(program_path):
    # input_path = "./input/bst1_instr.txt"
    start_time = time.time()
    subprocess.run(["zokrates", "compute-witness", "-a", "1", "360000000000", "1", "17904759277", "1", "3538782045", "1", "12015863319", "1", "26528449019", "1", "16945937538", "1", "9634043612", "1", "6394043787", "1", "589797008", "0", "999990000000000", "1", "644571333962", "1", "360000000000", "1", "6918175829", "1", "1418539498", "1", "4620052733", "1", "10353721365", "1", "6501064149", "1", "9153195873", "1", "4689987108", "1", "236423250", "0", "999990000000000", "1", "249054329850", "1", "0", "1", "490000000000", "1", "54678236122", "1", "74011882458", "1", "0", "1", "359806000000", "1", "30677200000", "1", "21763384366", "1", "57810268622", "1", "10573126065", "0", "999990000000000", "1", "2679233570000", "1", "50000000000", "1", "0", "1", "440000000000", "1", "256477272727", "1", "142574254605", "0", "35000000000", "1", "475000000000", "1", "272500000000", "0", "6346310419", "0", "3704631137", "1", "21493877604", "0", "999990000000000", "1", "11285000000000", "1", "360000000000", "0", "92623288862", "1", "18127037545", "0", "132460984911", "0", "60448929450", "0", "91192279514", "0", "2845884242", "0", "6548771326", "1", "3021172924", "0", "999990000000000", "0", "3334438399019", "1", "490000000000", "1", "247551020408", "1", "142463893265", "0", "60000000000", "1", "475000000000", "1", "250000000000", "0", "6099512120", "0", "2899719196", "1", "20351984752", "0", "999990000000000", "1", "12130000000000", "1", "10000000000", "1", "480000000000", "1", "300104166667", "1", "116698782940", "0", "70000000000", "1", "490000000000", "1", "317500000000", "0", "7510367051", "1", "14443085095", "1", "16844018436", "0", "999990000000000", "1", "14405000000000", "1", "160000000000", "1", "330000000000", "1", "102342129394", "1", "192526501837", "0", "329684000000", "1", "677689000000", "1", "45608600000", "1", "9881252514", "1", "24641335044", "1", "33514562149", "0", "999990000000000", "1", "3377290270000", "1", "0", "1", "0", "1", "490000000000", "1", "4846938776", "1", "12304149699", "0", "40000000000", "1", "36875000000", "1", "3125000000", "0", "3305014804", "1", "33092881158", "1", "1757735671", "0", "999990000000000", "1", "237500000000", "1", "0", "1", "180000000000", "1", "0", "1", "310000000000", "1", "139677419355", "1", "108558244611", "0", "255000000000", "1", "240000000000", "1", "160000000000", "0", "31488771247", "1", "99622837122", "1", "19497636311", "0", "999990000000000", "1", "4330000000000", "1", "410000000000", "1", "256707317073", "1", "146183146071", "0", "80000000000", "1", "490000000000", "1", "280000000000", "0", "6954836163", "0", "1113667812", "1", "22829971847", "0", "999990000000000", "1", "10525000000000", "1", "490000000000", "1", "305918367347", "1", "173276253030", "1", "10000000000", "1", "590000000000", "1", "300000000000", "1", "4862811", "0", "11977069957", "1", "24753750433", "0", "999990000000000", "1", "14990000000000", "1", "0", "1", "0", "1", "490000000000", "1", "9488776939", "1", "1461550223", "1", "2083330000", "1", "10350000000", "1", "9916670000", "0", "38679929838", "1", "157251657158", "1", "208792889", "0", "999990000000000", "1", "464950070000", "1", "160000000000", "1", "330000000000", "1", "78715069091", "1", "88073229229", "1", "2377830000", "1", "359806000000", "1", "42023800000", "1", "16887374731", "1", "25474914074", "1", "15331581297", "0", "999990000000000", "1", "2597597280000", "1", "460000000000", "1", "9238404348", "1", "2485120320", "1", "0", "1", "10000000000", "1", "9997825000", "0", "35573607045", "1", "113464572754", "1", "366411001", "0", "999990000000000", "1", "424966600000", "1", "0", "1", "140000000000", "1", "20000000000", "1", "0", "1", "0", "1", "0", "1", "70000000000", "1", "0", "1", "30000000000", "1", "150000000000", "1", "0", "1", "0", "1", "80000000000", "1", "10000000000", "1", "40000000000", "1", "70000000000", "1", "100000000000", "1", "130000000000", "1", "155000000000", "1", "186666666667", "1", "220000000000", "1", "250000000000", "1", "275000000000", "1", "306666666667", "1", "340000000000", "1", "375000000000", "1", "395000000000", "1", "426666666667", "1", "463333333333", "1", "495000000000", "1", "520000000000", "1", "550000000000", "1", "590000000000", "1", "215000000000", "1", "91666666667", "1", "107500000000", "1", "166666666667", "1", "150000000000", "1", "207500000000", "1", "220000000000", "1", "223333333333", "1", "302500000000", "1", "340000000000", "1", "385000000000", "1", "418333333333", "1", "432500000000", "1", "412500000000", "1", "346666666667", "1", "263333333333", "1", "290000000000", "1", "177500000000", "1", "90000000000", "1", "112500000000", "0", "1875000000", "1", "13750000000", "1", "0", "1", "8958333333", "1", "11875000000", "1", "6250000000", "1", "1250000000", "1", "11458333333", "1", "5937500000", "0", "3125000000", "1", "6250000000", "1", "5416666667", "1", "12500000000", "1", "11250000000", "1", "10625000000", "0", "3750000000", "1", "6250000000", "0", "1562500000", "0", "7500000000", "0", "937500000", "0", "999990000000000", "1", "34580500000", "1", "21735900000", "1", "16253650000", "0", "999990000000000", "1", "2377830000", "1", "7228620000", "1", "10234195000", "1", "32114050000", "1", "58225050000", "1", "123502333333", "1", "214044333333", "1", "275706000000", "1", "138889000000", "1", "52361050000", "1", "40643650000", "1", "26956100000", "1", "62988800000", "1", "115918000000", "0", "999990000000000", "0", "999990000000000", "1", "91666666667", "1", "107500000000", "1", "166666666667", "1", "65000000000", "1", "207500000000", "1", "220000000000", "1", "223333333333", "1", "302500000000", "1", "340000000000", "1", "385000000000", "1", "418333333333", "1", "432500000000", "1", "412500000000", "1", "346666666667", "1", "282500000000", "1", "290000000000", "1", "177500000000", "1", "165000000000", "0", "5000000000", "1", "0", "1", "9679596667", "1", "9692775000", "1", "9880360000", "1", "5000000000", "1", "10000000000", "1", "10000000000", "1", "9997813333", "1", "9996905000", "1", "9992940000", "1", "9999143333", "1", "9986640000", "1", "9960345000", "1", "9982300000", "1", "9935913333", "1", "6654720000", "1", "9996415000", "1", "9256265000", "1", "9406630000", "0", "999990000000000", "0", "999990000000000", "1", "39303200000", "0", "15586500000", "1", "49248850000", "0", "999990000000000", "0", "6492140000", "1", "30765013333", "0", "10736850000", "1", "39127000000", "1", "163601000000", "1", "288018083333", "1", "185013400000", "1", "464924000000", "1", "158660800000", "1", "36145150000", "1", "33035800000", "1", "136557360000", "1", "215415000000", "0", "329684000000", "0", "999990000000000", "1", "0", "1", "26572066667", "1", "22223350000", "1", "27569533333", "1", "0", "1", "1188915000", "1", "13764346667", "1", "13849033333", "1", "65026400000", "1", "89679650000", "1", "112703133333", "1", "178082500000", "1", "247844000000", "1", "121244000000", "1", "34907366667", "1", "18917200000", "1", "43423000000", "1", "22812600000", "1", "36045666667", "1", "0", "1", "130000000000", "1", "235000000000", "1", "212500000000", "1", "220000000000", "1", "227500000000", "1", "270000000000", "1", "280000000000", "1", "308333333333", "1", "377500000000", "1", "377500000000", "1", "458333333333", "1", "435000000000", "1", "432500000000", "1", "412500000000", "1", "351666666667", "1", "255000000000", "1", "330000000000", "1", "292500000000", "1", "183333333333", "0", "5000000000", "1", "10350000000", "1", "8194446667", "1", "7750000000", "1", "9816666667", "1", "9883315000", "1", "9983330000", "1", "10016676667", "1", "10150010000", "1", "9933335000", "1", "9966665000", "1", "9872223333", "1", "9927780000", "1", "9850000000", "1", "9816665000", "1", "9583333333", "1", "9905566667", "1", "9883335000", "1", "8950000000", "1", "6816666667", "1", "9866670000", "1", "225000000000", "1", "61666666667", "1", "150000000000", "1", "142500000000", "1", "55000000000", "1", "140000000000", "1", "195000000000", "1", "260000000000", "1", "310000000000", "1", "290000000000", "1", "378333333333", "1", "371666666667", "1", "467500000000", "1", "435000000000", "1", "303333333333", "1", "293333333333", "1", "265000000000", "1", "267500000000", "1", "45000000000", "0", "55000000000", "0", "999990000000000", "0", "98605285061", "0", "95986145242", "0", "104516481441", "0", "999990000000000", "0", "117367604351", "0", "111109023638", "0", "118178336374", "0", "95340555096", "0", "80789451051", "0", "77516781956", "0", "68654997882", "0", "70681770376", "0", "74875375344", "0", "89106290348", "0", "95075369449", "0", "98638994349", "0", "82428235791", "0", "80065997685", "0", "999990000000000"])
    return time.time() - start_time

# Function to generate proof and extract proof size and number of constraints
def generate_proof(program_path):
    subprocess.run(["zokrates", "setup"])
    subprocess.run(["zokrates", "export-verifier"])
    start_time = time.time()
    proof_output = subprocess.run(["zokrates", "generate-proof"])
    end_time = time.time()
    # Example of extracting proof size and constraints from the output
    # This depends on the format of the output from ZoKrates
    output_file_path = os.path.join(top_directory, 'proof.json')
    proof_size = get_file_size(output_file_path)
    
    return proof_size

def verify_proof(program_path):
    start_time = time.time()
    subprocess.run(["zokrates", "verify"])
    end_time = time.time()
    
    return end_time - start_time


# Main function to batch test ZoKrates programs
def batch_test_zokrates_programs():
    results = []

    for program in os.listdir(program_directory):
        # Skip hidden files and directories
        if program.startswith('.') or os.path.isdir(os.path.join(program_directory, program)):
            continue

        program_path = os.path.join(program_directory, program)
        compile_time, circuit_size = compile_program(program_path)
        execution_time = execute_program(program_path)
        proof_size = generate_proof(program_path)
        verification_time = verify_proof(program_path)

        results.append({
            "program": program,
            "compile_time": compile_time,
            "circuit_size": circuit_size,
            "execution_time": execution_time,
            "proof_size": proof_size,
            "verification_time": verification_time
        })

    # Write results to a JSON file
    with open('zokrates_test_results.json', 'w') as file:
        json.dump(results, file, indent=4)

batch_test_zokrates_programs()